{% extends 'cp_nigeria/steps/step_progression.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load i18n %}


{% block start_body_scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const csrfToken = `{{ csrf_token }}`;
	const dropdownUrl = `{% url 'ajax_load_timeseries' %}`;
    const updateGraphUrl = '{% url 'ajax_update_graph' %}';
</script>
<script src="{% static 'js/consumer_groups.js' %}"></script>
<script src="{% static 'js/dependent_dropdown.js' %}"></script>
<script src="{% static 'js/update_demand_graph.js' %}"></script>

{% endblock start_body_scripts %}
<!-- WRITE HTML CODE WITHIN THESE block content TAGS -->

{% block progression_content %}
<main>
    <div class="grid-container">
        <!--button class="btn btn--medium" type="button">{% translate "Upload load profile" %}</button-->
    </div>

    <form method="POST" id="consumer-group-form">
        {% csrf_token %}
        {{ formset.management_form | crispy}}
        <table class="table" id="ug_container" style="margin-bottom: 0">
            <thead>
            <th></th>
            <th>Consumer type</th>
            <th>Demand profile</th>
            <th>Nr. of consumers</th>

            </thead>
            <tbody>
            {% for form in formset %}
            <tr id="form-{{ forloop.counter0 }}" class="consumer--group" style="height: fit-content">
                <td>
									{% if allow_edition %}
                <button class="btn dropdown-toggle btn--transparent" type="button" id="dropdownMenuTS" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="icon icon-more"></span>
                </button>

                <ul class="dropdown-menu" aria-labelledby="dropdownMenuTS">
                    <li><a class="dropdown-item" id="delete-consumer-group">{% translate 'Delete consumer group' %}</a></li>
                    <li><a class="dropdown-item" href="{% url 'not_implemented' %}?url={{ request.get_full_path }}">{% translate 'Export as .xls' %}</a></li>
                </ul>

                <input type="hidden" name="{{ form.prefix }}-DELETE" id="{{ form.prefix }}-DELETE" value="false">
									{% endif %}
                </td>
                    {% for field in form %}
                    {% if field.name != 'DELETE' and field.name != 'community' %}

                    <td>
                        {{ field | as_crispy_field }}
                    </td>

                    {% endif %}
                    {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
					<tfoot>
   <tr>
		 {% if allow_edition %}
      <td colspan="4" style="text-align: center;padding-top:0">
				<button class="btn btn--small btn--transparent" type="button" id="add-consumer-group" style="margin-top:0.5rem">
								<span class="icon icon-add"></span>
								Add Consumer Group
							</button>

			</td>
		 {% endif %}
   </tr>
</tfoot>
        </table>



        </table>
        <div class="container">
            <div>
                <p>Avg. daily demand: <b id="avg_daily"></b> kWh</p>
                <p>Peak demand: <b id="peak_demand"></b> kW</p>
            </div>

            <div id="demand-aggregate">
            </div>
        </div>
        <center>
            <button class="btn btn--medium" type="submit">{% translate "Save load profile" %}</button>
        </center>
    </form>
</main>

{% endblock progression_content %}

{% block end_body_scripts %}
<script>
initialPlot();
</script>
{% endblock end_body_scripts %}
